var OLGA_MAIN=null,GLOBAL_PGN=null,BOARD_RATIO=100,OLGA_ROOT_DIR="/olga/";function initializeOLGA(e,t,o,n,i,a,A,r,s,_,l){var L={draggable:!0,position:"start",onDragStart:function(e,t,o,n){if(!0===OLGA_MAIN.engine.game_over()||"w"===OLGA_MAIN.engine.turn()&&-1!==t.search(/^b/)||"b"===OLGA_MAIN.engine.turn()&&-1!==t.search(/^w/))return!1},onDrop:function(e,t){var o=OLGA_MAIN.engine.move({from:e,to:t,promotion:"q"});if(null===o)return"snapback";makeVariationMove(o),updateStatus()},onSnapEnd:function(){OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())}};OLGA_MAIN=new OLGA(e,t,o,n,i,a,A,r,s,_,l,L),generateMoveList(),resizeOLGA(),restoreShortcutKeysStatus(),$(window).resize(resizeOLGA),0!=OLGA_MAIN.start_ply&&shmOLGA(OLGA_MAIN.start_ply),updateStatus()}function OLGA(e,t,o,n,i,a,A,r,s,_,l,L){var O,N="",G=document.getElementById("olga-data");if(null!=G){var u=G.getAttribute("color_light");u?(this.lightColor=u,$("#lightColor").val(u)):this.lightColor=$("#lightColor").val();var c=G.getAttribute("color_dark");c?(this.darkColor=c,$("#darkColor").val(c)):this.darkColor=$("#darkColor").val();var I=G.getAttribute("piece_theme");this.pieceTheme=I?OLGA_ROOT_DIR+"img/chesspieces/"+I+"/{piece}.png":OLGA_ROOT_DIR+"img/chesspieces/alpha/{piece}.png";var M=G.getAttribute("labels");this.coords=!M||"N"!=M;var h=G.getAttribute("start_ply");if(h){var d=parseInt(h);this.start_ply=d||0}else this.start_ply=0;$("#notation").prop("checked",this.coords);var p=G.getAttribute("pgn");p&&(N=p);var v=G.getAttribute("sessid");this.sessionID=v||"";var m=G.getAttribute("ratio");if(m){var g=parseInt(m);g&&(BOARD_RATIO=g)}else this.sessionID="";var f=G.getAttribute("notes");if(this.annotations=[],f){try{this.annotations=JSON.parse(f)}catch(e){}for(var b=[],y=0;y<this.annotations.length-1;y+=2)b[this.annotations[y]]=this.annotations[y+1];this.annotations=b}}else this.lightColor=$("#lightColor").val(),this.darkColor=$("#darkColor").val(),this.sessionID="",this.annotations=[];this.autoTimer=null,this.orientation=!0,GLOBAL_PGN=N,this.engine=new Chess,this.move=-1,this.branch_half=-1,this.usingVariation=!1,this.moveList=[],this.variationList=[],this.history=[],this.timerValue=3100,void 0===L?(this.onDragStart=function(){},this.onDrop=function(){},this.onSnapEnd=function(){},O={draggable:!0,position:"start",showNotation:this.coords,onDragStart:this.onDragStart,onDrop:this.onDrop,onSnapEnd:this.onSnapEnd,pieceTheme:this.pieceTheme}):(this.onDragStart=L.onDragStart,this.onDrop=L.onDrop,this.onSnapEnd=L.onSnapEnd,O={draggable:!0,position:"start",showNotation:this.coords,onDragStart:this.onDragStart,onDrop:this.onDrop,onSnapEnd:this.onSnapEnd,pieceTheme:this.pieceTheme}),this.container=document.getElementById(e),this.board_div=document.getElementById(t),this.notes="#"+o,this.variation_box="#"+a,this.status_id="#"+A,this.status_t_id="#"+r,this.auto_btn_id="#"+s,this.variations="#"+i,this.score_box="#"+n;window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(this.board_css_ratio=parseFloat($("."+t).css("width")),this.alpha_id="."+_,this.numeric_id="."+l,this.alpha_width=parseFloat($(this.alpha_id).css("font-size")),this.numeric_width=parseFloat($(this.numeric_id).css("font-size")),this.board_css_ratio>45?this.board_css_ratio=1:this.board_css_ratio=.45,$("#startB").bind("click",function(e){e.preventDefault(),pgnStart()}),$("#prevB").bind("click",function(e){e.preventDefault(),pgnPrevious()}),$("#nextB").bind("click",function(e){e.preventDefault(),pgnNext()}),$("#endB").bind("click",function(e){e.preventDefault(),pgnEnd()}),$("#autoB").bind("click",function(e){e.preventDefault(),pgnAuto()}),$(".chessboard-63f37").remove(),this.board=ChessBoard(t,O),0!==N.length){this.engine.load_pgn(N,{sloppy:!0});this.history=this.engine.history({verbose:!0}),this.end=this.engine.fen();for(y=0;y<this.history.length;y++)this.engine.undo();this.start=this.engine.fen(),this.board.position(this.start)}}var updateStatus=function(){var e="",t="White";"b"===OLGA_MAIN.engine.turn()&&(t="Black"),!0===OLGA_MAIN.engine.in_checkmate()?e="Game over, checkmate.":!0===OLGA_MAIN.engine.in_threefold_repetition()?(e="Three time repetition claimable, ",e+=t+" to move",!0===OLGA_MAIN.engine.in_check()&&(e+=" Check.")):!0===OLGA_MAIN.engine.in_draw()?e="Game over, drawn position":(e=t+" to move.",!0===OLGA_MAIN.engine.in_check()&&(e+=" Check."));var o=OLGA_MAIN.move;o>-1&&(e+=" Last: ",e+=o%2==0?o/2+1+".":(o+1)/2+"...",OLGA_MAIN.usingVariation?e+=OLGA_MAIN.variationList[OLGA_MAIN.move-OLGA_MAIN.branch_half].san:e+=OLGA_MAIN.history[OLGA_MAIN.move].san),$(OLGA_MAIN.status_id).find("div").empty(),$(OLGA_MAIN.status_id).find("div").append(OLGA_MAIN.engine.fen()),$(OLGA_MAIN.status_t_id).empty(),$(OLGA_MAIN.status_t_id).append(e)};function pgnStart(){if(null!==OLGA_MAIN.autoTimer&&clearAuto(),OLGA_MAIN.usingVariation)shvOLGA(OLGA_MAIN.branch_half);else{OLGA_MAIN.board.position(OLGA_MAIN.start);for(var e=OLGA_MAIN.move+1;e>0;--e)OLGA_MAIN.engine.undo();OLGA_MAIN.move=-1}updateStatus(),updateCurrentMove()}function pgnNext(){null!==OLGA_MAIN.autoTimer&&clearAuto(),OLGA_MAIN.usingVariation?OLGA_MAIN.move-OLGA_MAIN.branch_half<OLGA_MAIN.variationList.length-1&&(OLGA_MAIN.move+=1,move=OLGA_MAIN.variationList[OLGA_MAIN.move-OLGA_MAIN.branch_half],OLGA_MAIN.engine.move(move),OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())):OLGA_MAIN.move<OLGA_MAIN.history.length-1&&(OLGA_MAIN.move+=1,move=OLGA_MAIN.history[OLGA_MAIN.move],OLGA_MAIN.engine.move(move),OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())),updateStatus(),updateCurrentMove(),updatePlyNote()}function pgnPrevious(){if(null!==OLGA_MAIN.autoTimer&&clearAuto(),OLGA_MAIN.move>=0)if(OLGA_MAIN.usingVariation){if(OLGA_MAIN.move>OLGA_MAIN.branch_half){OLGA_MAIN.move-=1;OLGA_MAIN.engine.undo();OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())}}else{OLGA_MAIN.move-=1;OLGA_MAIN.engine.undo();OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())}updateStatus(),updateCurrentMove(),updatePlyNote()}function pgnNextA(){if(clearTimeout(OLGA_MAIN.autoTimer),OLGA_MAIN.usingVariation)if(OLGA_MAIN.move-OLGA_MAIN.branch_half<OLGA_MAIN.variationList.length-1){OLGA_MAIN.move+=1,e=OLGA_MAIN.variationList[OLGA_MAIN.move-OLGA_MAIN.branch_half];var e=OLGA_MAIN.variationList[OLGA_MAIN.move-OLGA_MAIN.branch_half];OLGA_MAIN.engine.move(e),OLGA_MAIN.board.position(OLGA_MAIN.engine.fen()),OLGA_MAIN.autoTimer=setTimeout(pgnNextA,OLGA_MAIN.timerValue)}else clearAuto();else if(OLGA_MAIN.move<OLGA_MAIN.history.length-1){OLGA_MAIN.move+=1;e=OLGA_MAIN.history[OLGA_MAIN.move];OLGA_MAIN.engine.move(e),OLGA_MAIN.board.position(OLGA_MAIN.engine.fen()),OLGA_MAIN.autoTimer=setTimeout(pgnNextA,OLGA_MAIN.timerValue)}else clearAuto();updateStatus(),updateCurrentMove(),updatePlyNote()}function pgnEnd(){if(null!==OLGA_MAIN.autoTimer&&clearAuto(),OLGA_MAIN.usingVariation)for(var e=OLGA_MAIN.variationList.length-(OLGA_MAIN.move-OLGA_MAIN.branch_half);e>0;--e)pgnNext();else{OLGA_MAIN.board.position(OLGA_MAIN.end);var t=OLGA_MAIN.history.length;for(e=t-OLGA_MAIN.move;e>0;--e){var o=OLGA_MAIN.history[t-e];OLGA_MAIN.engine.move(o)}OLGA_MAIN.move=OLGA_MAIN.history.length-1}updateCurrentMove(),updateStatus(),updatePlyNote()}function clearAuto(){clearTimeout(OLGA_MAIN.autoTimer),OLGA_MAIN.autoTimer=null,$(OLGA_MAIN.auto_btn_id).empty(),$(OLGA_MAIN.auto_btn_id).append("+")}function pgnAuto(){OLGA_MAIN.autoTimer?clearAuto():(OLGA_MAIN.autoTimer=setTimeout(pgnNextA,100),$(OLGA_MAIN.auto_btn_id).empty(),$(OLGA_MAIN.auto_btn_id).append("="))}function resizeOLGA(){var e=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,t=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,o=BOARD_RATIO/100;if(t>e)OLGA_MAIN.board_div.style.width=BOARD_RATIO+"%",OLGA_MAIN.board.resize(),$(OLGA_MAIN.alpha_id).css("font-size",OLGA_MAIN.alpha_width*o),$(OLGA_MAIN.numeric_id).css("font-size",OLGA_MAIN.numeric_width*o);else{OLGA_MAIN.board_div.style.width=OLGA_MAIN.board_css_ratio*BOARD_RATIO+"%",OLGA_MAIN.board.resize(),$(OLGA_MAIN.alpha_id).css("font-size",OLGA_MAIN.alpha_width*o),$(OLGA_MAIN.numeric_id).css("font-size",OLGA_MAIN.numeric_width*o)}setLightColor(OLGA_MAIN.lightColor),setDarkColor(OLGA_MAIN.darkColor)}function makeVariationMove(e){if(OLGA_MAIN.move++,OLGA_MAIN.usingVariation)if(OLGA_MAIN.move-OLGA_MAIN.branch_half==OLGA_MAIN.variationList.length)e.move=OLGA_MAIN.move,appendVariation(e);else{$(OLGA_MAIN.variation_box).empty();var t=OLGA_MAIN.variationList;OLGA_MAIN.variationList=[];for(var o=0;o<OLGA_MAIN.move-OLGA_MAIN.branch_half;o++){appendVariation(t[o])}e.move=OLGA_MAIN.move,appendVariation(e)}else clearVariationList(),OLGA_MAIN.branch_half=OLGA_MAIN.move,OLGA_MAIN.usingVariation=!0,e.move=OLGA_MAIN.move,appendVariation(e),$(OLGA_MAIN.variations).show("fast");updateCurrentMove(),updatePlyNote()}function exitVariation(){for(var e=OLGA_MAIN.move-OLGA_MAIN.branch_half;e>0;--e)pgnPrevious();OLGA_MAIN.usingVariation=!1,pgnPrevious(),clearVariationList()}function changePGNFile(e){var t=new FileReader;t.onload=function(e){setNewPGN(e.target.result)},t.readAsText(e)}function setNewPGN(e){OLGA_MAIN.engine.load_pgn(e);OLGA_MAIN.history=OLGA_MAIN.engine.history({verbose:!0}),OLGA_MAIN.end=OLGA_MAIN.engine.fen();for(var t=0;t<OLGA_MAIN.history.length;t++)OLGA_MAIN.engine.undo();updateMoveList()}function updateMoveList(){clearMoveList(),generateMoveList()}function appendVariation(e){var t=OLGA_MAIN.variationList.length;OLGA_MAIN.variationList[t]=e;var o="<a style='word-break:keep-all;' onclick='shvOLGA(";o+=e.move,o+=")' id='va",o+=e.move,o+="' class='pgn_move pgn_var_select'>",e.move%2==0?o+=e.move/2+1+".&nbsp":0==t&&(o+=(e.move+1)/2+"..."),o+=e.san+"&nbsp",o+="</a>",$(OLGA_MAIN.variation_box).append(o)}function clearVariationList(){OLGA_MAIN.usingVariation=!1,$(OLGA_MAIN.variation_box).empty(),OLGA_MAIN.variationList=null,OLGA_MAIN.variationList=[],$(OLGA_MAIN.variations).hide("fast")}function clearMoveList(){$(OLGA_MAIN.score_box).empty()}function generateMoveList(){for(var e="",t=OLGA_MAIN.history.length,o=!1,n=0;n<t;n++){var i=OLGA_MAIN.history[n],a=OLGA_MAIN.annotations[n];if(e+="<button onclick='shmOLGA(",e+=n,e+=")' id='mv",e+=n,n%2==0?(e+="' class='pgn_move pgn_scorew'>",e+=n/2+1+"."):(e+="' class='pgn_move pgn_scoreb'>",o&&(e+=(n+1)/2+"...")),e+=i.san,void 0!==a){for(var A=a[0],r=0;void 0!==A&&("?"===A||"!"===A);)e+=A,A=a[++r];a=a.substr(r),OLGA_MAIN.annotations[n]=a}e+="</button>",o=!1,void 0!==a&&(e+="<font>"+a+"</font>",o=!0)}var s=OLGA_MAIN.engine.header().Result;s&&(e+="<font style='color:black;'>"+s+"</font>"),$(OLGA_MAIN.score_box).append(e)}function setDarkColor(e){applyDarkColor(e),OLGA_MAIN.darkColor=e}function setLightColor(e){applyLightColor(e),OLGA_MAIN.lightColor=e}function synchronizeOLGA(){if(OLGA_MAIN.updateTimer&&(clearTimeout(OLGA_MAIN.updateTimer),OLGA_MAIN.updateTimer=null),""!==OLGA_MAIN.sessionID){var e="session_id="+OLGA_MAIN.sessionID;e+="&color_light="+OLGA_MAIN.lightColor.substr(1),e+="&color_dark="+OLGA_MAIN.darkColor.substr(1),e+="&labels=",OLGA_MAIN.coords?e+="Y":e+="N",e+="&ratio="+BOARD_RATIO,$.get("http://www.chessgames.com/perl/user_api",e,function(e){console.log(e)},"json")}}function updateCurrentMove(){var e=OLGA_MAIN.move;$(".current_scorew").attr("class","pgn_move pgn_scorew"),$(".current_scoreb").attr("class","pgn_move pgn_scoreb"),$(".pgn_var_select").attr("class","pgn_move pgn_variation"),OLGA_MAIN.usingVariation?($("#va"+e).attr("class","pgn_move pgn_var_select"),OLGA_MAIN.branch_half%2==0?$("#mv"+OLGA_MAIN.branch_half).attr("class","pgn_move current_scorew"):$("#mv"+OLGA_MAIN.branch_half).attr("class","pgn_move current_scoreb")):e%2==0?$("#mv"+e).attr("class","pgn_move current_scorew"):$("#mv"+e).attr("class","pgn_move current_scoreb")}function updatePlyNote(){var e;OLGA_MAIN.usingVariation?void 0!==(e=OLGA_MAIN.annotations[OLGA_MAIN.branch_half-1])&&""!==e?($(OLGA_MAIN.notes).empty(),$(OLGA_MAIN.notes).append(e),$(OLGA_MAIN.notes).show()):($(OLGA_MAIN.notes).empty(),$(OLGA_MAIN.notes).hide()):void 0!==(e=OLGA_MAIN.annotations[OLGA_MAIN.move])&&""!==e?($(OLGA_MAIN.notes).empty(),$(OLGA_MAIN.notes).append(e),$(OLGA_MAIN.notes).show()):($(OLGA_MAIN.notes).empty(),$(OLGA_MAIN.notes).hide())}function upscaleOLGA(){(BOARD_RATIO+=5)>210&&(BOARD_RATIO=210),resizeOLGA()}function downscaleOLGA(){(BOARD_RATIO-=5)<20&&(BOARD_RATIO=20),resizeOLGA()}function redrawBoard(){OLGA_MAIN.board.resize(),setLightColor(OLGA_MAIN.lightColor),setDarkColor(OLGA_MAIN.darkColor)}function flipOrientation(){OLGA_MAIN.orientation=!OLGA_MAIN.orientation,OLGA_MAIN.board.orientation("flip"),setLightColor(OLGA_MAIN.lightColor),setDarkColor(OLGA_MAIN.darkColor),window.scrollTo(0,0)}function toggleNotation(){var e,t=!OLGA_MAIN.coords,o=OLGA_MAIN.engine.fen();e=OLGA_MAIN.orientation?"white":"black";var n={draggable:!0,position:o,onDragStart:OLGA_MAIN.onDragStart,onDrop:OLGA_MAIN.onDrop,onSnapEnd:OLGA_MAIN.onDrop,showNotation:t,pieceTheme:OLGA_MAIN.pieceTheme,orientation:e};$(".chessboard-63f37").remove(),OLGA_MAIN.board=ChessBoard("board",n),OLGA_MAIN.coords=t,$("#notation").empty(),t?$("#notation").append("&nbsp;ON&nbsp;"):$("#notation").append("OFF&nbsp;"),applyLightColor(OLGA_MAIN.lightColor),applyDarkColor(OLGA_MAIN.darkColor),window.scrollTo(0,0)}function toggleOptions(){$("#board-options").toggle(350)}function shmOLGA(e){if(null!==OLGA_MAIN.autoTimer&&clearAuto(),OLGA_MAIN.usingVariation){for(var t=OLGA_MAIN.move-OLGA_MAIN.branch_half;t>=0;--t)OLGA_MAIN.engine.undo();OLGA_MAIN.move=OLGA_MAIN.branch_half-1,clearVariationList()}if(OLGA_MAIN.move>e&&e>=0){for(t=OLGA_MAIN.move-e;t>0;--t){OLGA_MAIN.move-=1;OLGA_MAIN.engine.undo()}OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())}if(OLGA_MAIN.move<e&&e<OLGA_MAIN.history.length){for(t=e-OLGA_MAIN.move;t>0;--t){OLGA_MAIN.move+=1;var o=OLGA_MAIN.history[OLGA_MAIN.move];OLGA_MAIN.engine.move(o)}OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())}updateStatus(),updateCurrentMove(),updatePlyNote()}function shvOLGA(e){if(null!==OLGA_MAIN.autoTimer&&clearAuto(),!OLGA_MAIN.usingVariation){for(var t=OLGA_MAIN.move-OLGA_MAIN.branch_half;t>=0;--t)OLGA_MAIN.engine.undo();OLGA_MAIN.move=OLGA_MAIN.branch_half-1,OLGA_MAIN.usingVariation=!0}if(OLGA_MAIN.move>e&&e>=OLGA_MAIN.branch_half){for(t=OLGA_MAIN.move-e;t>0;--t){OLGA_MAIN.move-=1;OLGA_MAIN.engine.undo()}OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())}if(OLGA_MAIN.move<e&&e-OLGA_MAIN.branch_half<OLGA_MAIN.variationList.length){for(t=e-OLGA_MAIN.move;t>0;--t){OLGA_MAIN.move+=1;var o=OLGA_MAIN.variationList[OLGA_MAIN.move-OLGA_MAIN.branch_half];OLGA_MAIN.engine.move(o)}OLGA_MAIN.board.position(OLGA_MAIN.engine.fen())}updateStatus(),updateCurrentMove(),updatePlyNote()}function applyDarkColor(e){var t=document.getElementsByClassName("black-3c85d");for(i=0;i<t.length;i++)t[i].style.backgroundColor=e;t=document.getElementsByClassName("white-1e1d7");for(i=0;i<t.length;i++)t[i].style.color=e}function applyLightColor(e){var t=document.getElementsByClassName("white-1e1d7");for(i=0;i<t.length;i++)t[i].style.backgroundColor=e;t=document.getElementsByClassName("black-3c85d");for(i=0;i<t.length;i++)t[i].style.color=e}function delayedNotify(){OLGA_MAIN.updateTimer&&clearTimeout(OLGA_MAIN.updateTimer),OLGA_MAIN.updateTimer=setTimeout(synchronizeOLGA,1e4)}function disableShortcutKeysAndStoreStatus(){document.onkeydown=null}function setAutoDelay(e){OLGA_MAIN.timerValue=1e3*e+100}function restoreShortcutKeysStatus(){document.onkeydown=function(e){switch(e.keyCode){case 32:pgnAuto(),e.preventDefault();break;case 37:pgnPrevious(),e.preventDefault();break;case 38:pgnStart(),e.preventDefault();break;case 39:pgnNext(),e.preventDefault();break;case 40:pgnEnd(),e.preventDefault();break;case 48:setAutoDelay(0),e.preventDefault();break;case 49:setAutoDelay(1),e.preventDefault();break;case 50:setAutoDelay(2),e.preventDefault();break;case 51:setAutoDelay(3),e.preventDefault();break;case 52:setAutoDelay(4),e.preventDefault();break;case 53:setAutoDelay(5),e.preventDefault();break;case 54:setAutoDelay(6),e.preventDefault();break;case 55:setAutoDelay(7),e.preventDefault();break;case 56:setAutoDelay(8),e.preventDefault();break;case 57:setAutoDelay(9),e.preventDefault();break;case 73:flipOrientation(),e.preventDefault()}}}function copyFEN(){SelectText("fb");try{if(document.execCommand("copy")){var e=document.getElementById("snackbar");e.className="show",setTimeout(function(){e.className=e.className.replace("show","")},2e3)}}catch(e){}}function sendForAnalysis(){var e;e=OLGA_MAIN.move/2+1;var t="http://www.chessgames.com/perl/nph-analysis_prereq?atype=FEN&fen=";t+=OLGA_MAIN.engine.fen().split(" ").join("%20"),t+="&move=",t+=e,t+="&session_id=",t+=OLGA_MAIN.sessionID,window.open(t)}function SelectText(e){var t,o,n=document,i=n.getElementById(e);n.body.createTextRange?((t=document.body.createTextRange()).moveToElementText(i),t.select()):window.getSelection&&(o=window.getSelection(),(t=document.createRange()).selectNodeContents(i),o.removeAllRanges(),o.addRange(t))}
